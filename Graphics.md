## 图形渲染相关知识

#### 渲染管线

        （1）顶点着色器
        此阶段是完全可编程的。此阶段的输入是单个顶点（虽然实际上会并行处理多个顶点）。顶点位置及法矢量通常以模型空间或世界空间表示。
        此阶段也会进行透视投影、每顶点光照及纹理计算，以及为动画角色计算蒙皮。顶点着色器也可以通过修改顶点位置来产生程序式动画。例
        如模拟风吹草动或碧波荡漾。此阶段的输出是完成变换以及光照后的顶点 ，其位置及法矢量是以其次裁剪空间表示的。（顶点通过投影矩阵
        从观察空间转换到齐次裁剪空间）

        （2）几何着色器
        可选的几何着色阶段也是完全可编程的。几何着色器处理以齐次裁剪空间表示的整个图元（三角形、线段、点）。它能剔除或修改输入的图
        元，又能生成新的图元。其典型应用包括阴影体积拉伸(shadow volume extrusion)、渲染立方体贴图(cube map)的6个面、在网络
        的轮廓边拉伸毛发的鳍、从点数据生成粒子四边形、动态镶嵌、把线段以分形细分模拟闪电效果、布料模拟等。

        （3）流输出
        现在的GPU容许把达致此管道阶段的数据写回内存。数据能从那里回到管道之始做进一步处理。此功能称为流输出(stream out)。
        通过使用流输出，许多迷人的效果可以不经过CPU实现。其中一个绝佳的例子是头发渲染。头发通常是由三次样条曲线(cubic spline 
        curve)的集合表示的。以往头发通常在CPU上进行物理模拟，然后在CPU上把样条镶嵌为线段，最后由GPU渲染那些线段。
        有了流输出，GPU便可于顶点着色器内，在头发样条的控制点上进行物理模拟。几何着色器则把样条镶嵌成线段，并用流输出功能把镶嵌后的
        顶点数据写入内存。最后那些线段被重新流入管道之始去渲染。

        （4）裁剪
        裁剪(clipping)阶段把三角形在平截头体以外的部分切掉。其原理是先判定哪些顶点在平截头体以外，然后求出三角形的棱和平截头体的平
        面之间的相交点。这些相交点会成为一个或多个裁剪后三角形的新顶点。
        此阶段是固定功能，但提供有限度配置。例如，除了平截头体的平面外，用户能定义额外的裁剪平面。此阶段也能配置剔除完全在平截头体以
        外的三角形。

        （5）屏幕映射
        屏幕映射(screen mapping)只是简单地缩放和平移顶点，使之从齐次裁剪空间变换至屏幕空间。此阶段是完全固定且不能配置的。

        （6）三角形建立
        自三角形建立(triangle setup)阶段，光栅化硬件开始迅速把三角形转化成片段。此阶段是不能配置的。

        （7）三角形遍历
        三角形遍历(triangle setup)阶段把三角形分解为片段（即光栅化）。通常每个像素会产生一个片段，除非是使用MSAA，那么每个像素会
        产生多个片段。三角形遍历也会对顶点属性进行插值，以产生每片段(per-fragment)属性，供像素着色器使用。此阶段的功能也是固定且不
        能配置的。

        （8）提前深度测试
        许多显卡能够在管道的此时间点检查片段的深度，若某片段会被帧缓冲的像素遮挡，就在此丢弃该片段。这么做对于所有被遮挡片段，能直接
        跳过（可能非常耗时的）像素着色器阶段。
        并非所有图形硬件都支持在此管道阶段进行深度测试。在过去的GPU设计中，深度测试和alpha测试都是在像素着色器之后才进行的。因此，
        此阶段成为提前z测试或提前深度测试。

        （9）像素着色器
        像素着色器是完全可编程阶段。其工作是替每个像素着色（即光照及其他处理）。像素着色器也能丢弃一些片段，例如，某些片段被判断为完
        全透明。像素着色器可以对多个纹理采样、计算每像素光照以及任何会影响片段颜色的计算。
        此阶段的输入是一个每片段属性（这些属性是在三角形遍历中通过对顶点属性插值所得）。而输出是一个颜色矢量，代表所要的片段颜色。
        
        （10）合并/光栅运算阶段
        管道的最终阶段为合并阶段(merge stage)或混合阶段(blending stage)，NVIDIA称之为光栅运算阶段(raster operations 
        stage)。
        此阶段不能编程，但能高度配置。此阶段负责执行多个片段测试，包括深度测试、alpha测试，以及模板测试。

<br>

#### 将一个局部坐标系中的点转换到屏幕上的二维点，需要经历的计算过程

        （1）由局部空间转换到世界空间
                worldPos = modelMat * modelPos
        （2）由世界空间转换到观察空间
                viewPos = viewMat * worldPos
        （3）由观察空间转换到齐次裁剪空间
                homogeneousPos = projectionMat * viewPos
        （4）齐次坐标转换为三维坐标
                clipPos = homogeneousPos / w
        （5）由齐次裁剪空间转换到屏幕空间（屏幕映射）
                (clipPos.x + 1.0) * 0.5 * (width - 1.0)
                (clipPos.y + 1.0) * 0.5 * (height - 1.0)
        
        渲染以齐次裁剪空间表示的三角形时，可以只用其x、y坐标而忽略z。

        当点或矢量从三维延伸至四维，便称为齐次坐标(homogeneous coordinates)。当要把齐次坐标转换为三维坐标时，要把x、y、z分量
        除以w。
        进行透视投影后，每个顶点的x和y坐标会除以其z坐标。这个除法是产生透视收缩的方法。




